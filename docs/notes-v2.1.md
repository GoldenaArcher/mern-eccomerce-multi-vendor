# [MERN é¡¹ç›®å®æˆ˜] MERN Multi-Vendor ç”µå•†å¹³å°å¼€å‘ç¬”è®°ï¼ˆv2.1 åŸºç¡€å·¥ç¨‹åŒ–ï¼šTurborepo + Yarn Workspacesï¼‰

åˆæ˜¯ä¸€èµ·æ¯”æƒ³è±¡ä¸­å‡ºç°çš„æ—©çš„æ–‡ç« ï¼Œå†™è¿™ä¸€ç¯‡çš„åˆå¿ƒä¸»è¦æ˜¯æ¥è‡ªäº 2.0 çš„ç¬”è®°ä¸­æå‡ºäº†ä¸€ä¸ªç–‘é—®ï¼šå¾®å‰ç«¯æ˜¯è§£å†³ä¸šåŠ¡é€»è¾‘é‡å¤çš„é—®é¢˜å—ï¼Ÿ

è¿™é‡Œç›´æ¥åšä¸ªå›ç­”å§ï¼Œä¸æ˜¯ âŒï¼Œå‰ç«¯å·¥ç¨‹åŒ–æ‰æ˜¯è§£é¢˜æ€è·¯ï¼Œè€Œç»å†è¿‡ä¸¤ä¸ªå¤§ç‰ˆæœ¬çš„å˜æ›´ï¼Œä» 1.0 çš„åŸºç¡€åç«¯+dashboard UIï¼Œåˆ° 2.0 çš„ storefront UIï¼Œç°åœ¨å·²ç»å‡ºç°äº† 2 ä¸ª UI ç•Œé¢ï¼Œä¹Ÿç¡®å®è¿æ¥äº†æ›´å¤šé‡å¤ä»£ç çš„æŒ‘æˆ˜

åœ¨èŠ±äº†ä¸¤å¤©çš„æ—¶é—´å­¦ä¹ å’Œç ”ç©¶ï¼Œè‡ªè§‰æœ‰äº†äº›æˆæœï¼Œæ‰“ç®—è¶ç€è®°å¿†è¿˜æ²¡æ¶ˆé€€çš„æ—¶å€™ï¼Œç³»ç»Ÿæ€§åœ°æ•´ç†ä¸€ä¸‹

ä¹‹å‰çš„ç¬”è®°å¯ä»¥å‚è€ƒï¼š

- [**[MERN] é¡¹ç›®å®æˆ˜ã€‘MERN Multi-Vendor ç”µå•†å¹³å°å¼€å‘ç¬”è®°ï¼ˆv1.0 åˆç‰ˆç»“æ„ + æŠ€æœ¯å®è·µï¼‰**](https://goldenaarcher.blog.csdn.net/article/details/147279112)
- [**[MERN é¡¹ç›®å®æˆ˜] MERN Multi-Vendor ç”µå•†å¹³å°å¼€å‘ç¬”è®°ï¼ˆv2.0 ä» bug åˆ°ç»“æ„ä¼˜åŒ–çš„å·¥ç¨‹è®°å½•ï¼‰**](https://blog.csdn.net/weixin_42938619/article/details/147476450)

æ„Ÿå…´è¶£çš„ä¹Ÿå¯ä»¥æˆ³ä¸€ä¸‹ github åœ°å€ï¼Œä¸è¿‡ç°åœ¨è¿™ä¸ªä»£ç è¿˜æ˜¯åœ¨æ›´æ–°ä¸­çš„ï¼š

[https://github.com/GoldenaArcher/mern-eccomerce-multi-vendor](https://github.com/GoldenaArcher/mern-eccomerce-multi-vendor)

---

## ğŸ‘€Â  é—®é¢˜å›é¡¾

åœ¨ 2.0 çš„ç¬”è®°ä¸­æˆ‘æåˆ°è¿‡ä¸€ä¸ªé—®é¢˜ï¼Œå³ UI éƒ¨åˆ†çš„ä»£ç ï¼Œåœ¨è¿˜æ²¡æœ‰å¼€å§‹æ­£å¼çš„ä¸šåŠ¡å®ç°æ—¶å·²ç»å‡ºç°äº†ä¸å°‘çš„é‡å¤ï¼Œå¦‚ï¼š

```jsx
import { clsx } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs]) {
  return twMerge(clsx(inputs));
}
```

è¿™æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ util æ–¹æ³•ï¼Œä¸»è¦å¤„ç†çš„æ˜¯ tailwind çš„ CSS åˆå¹¶é—®é¢˜ã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œè¿™æ ·çŸ­çš„çº¯å‡½æ•°ç®¡ç†èµ·æ¥å¯èƒ½ä¸ä¼šç‰¹åˆ«çš„å¤æ‚ï¼Œæ¯•ç«Ÿä¹Ÿå°±æ˜¯å…¨å±€æœç´¢ cv å‡ éï¼Œå…¶å®ä¸ç„¶â€¦â€¦

2.0 ä¸­æåˆ°è¿‡ä¸€ä¸ª workspace åœ¨ä½¿ç”¨æŸä¸ªç¬¬ä¸‰æ–¹æ’ä»¶çš„æ—¶å€™ï¼Œå› ä¸º React ç‰ˆæœ¬ä¸åŒçš„é—®é¢˜ï¼Œå‡ºç°äº† `Invalid hook call` çš„é—®é¢˜ã€‚è¿™ç§æƒ…å†µä¹Ÿå¯èƒ½å‡ºç°åœ¨è¿™ç§æ’ä»¶ä¸Šï¼Œå°¤å…¶æ˜¯åœ¨ä¸å°‘é¡¹ç›®ä¸­ï¼Œé»˜è®¤éƒ½æ˜¯ä¸‹è½½æœ€æ–°çš„ç‰ˆæœ¬ï¼Œè¿™æ›´æœ‰å¯èƒ½ä¼šé€ æˆå†²çª

å½“æ—¶çš„è§£å†³æ–¹æ³•å°±æ˜¯åœ¨æ ¹ç›®å½•çš„ package.json ä¸­ç”¨ resolution ç»Ÿä¸€ç‰ˆæœ¬ï¼Œéšåå†ç”¨ `yarn install --force` å¼ºåˆ¶è§„å®šç‰ˆæœ¬ä¸€è‡´ã€‚çŸ­æœŸå†…è¿™æ ·çš„æ“ä½œæ˜¯è§£å†³äº†ä¸€äº›é—®é¢˜ï¼Œä½†æ˜¯ä»é•¿æœŸæ¥çœ‹ï¼Œè¿™ä¾æ—§æ— æ³•è§£å†³åæœŸå¯èƒ½ä¼šå‡ºç°çš„å‡çº§ï¼Œè€Œå¯¼è‡´çš„éº»çƒ¦â€”â€”åŒæ ·çš„ä»£ç  cv å¥½å‡ æ¬¡ï¼ŒåŒæ ·çš„ bug ä¿®å¤å¥½å‡ æ¬¡ï¼›è¶Šæ˜¯æ‹…å¿ƒè¿™æ ·çš„é—®é¢˜è¶Šæ— æ³•å‡çº§ï¼Œä½†æ˜¯éšç€ä¸‹è½½çš„ dependencies åˆ°äº† EOLï¼Œåˆä¸å¾—ä¸é¢å¯¹è¿™æ ·çš„é—®é¢˜â€¦â€¦

ä¼—æ‰€å‘¨çŸ¥ï¼Œå¼€å‘æœ‰ä¸¤ä¸ªéå¸¸çŸ¥åçš„åŸåˆ™ï¼š

- **Don't repeat yourself - DRYï¼Œ**ä¸è¦é‡å¤è‡ªå·±
- **Keep it simple, stupid - KISSï¼Œç»´æŒæ„šè ¢ç®€å•**

é‚£è§£å†³æ€è·¯å…¶å®åº”è¯¥ä¹Ÿè¦ä»è¿™ä¸¤ä¸ªæ–¹å‘ç€æ‰‹

~~å‰è€…å€’æ˜¯å¯ä»¥æ»¡è¶³äº†ï¼Œåè€…â€¦â€¦å…¶å®ä»é…ç½®ä¸Šæ¥è¯´å¹¶æ²¡æœ‰ç®€å•å¾ˆå¤šï¼Œä¸è¿‡ä¹‹åå¦‚æœè¦åšç»´æŠ¤å€’æ˜¯ä¼šç®€å•ä¸å°‘~~

## ğŸ” é—®é¢˜åˆ†æ

åˆšå¼€å§‹çš„é¡¹ç›®è®¾è®¡å€’æ˜¯é¢‡æœ‰å…ˆè§ä¹‹æ˜ï¼Œé‡‡å–äº† turborepo+yarn workspace çš„æ–¹å¼è¿›è¡Œç®¡ç†â€”â€”è¿™é‡Œè™½ç„¶æœ‰ç‚¹ç‹å©†å–ç“œï¼Œè‡ªå–è‡ªå¤¸ä¹‹å«Œï¼Œä¸è¿‡å½“æ—¶ä¹Ÿç¡®å®è€ƒè™‘åˆ°äº†åæœŸå¯èƒ½ä¼šå‡ºç°ä¸€äº›å‰åç«¯çš„ä»£ç é‡å¤é—®é¢˜ï¼Œå°¤å…¶æ˜¯ API ä¹‹é—´æ•°æ®çš„ç±»å‹ï¼Œè¿™ç§å¦‚æœå¯ä»¥æƒ³åŠæ³•æ‹‰å‡ºæ¥åšæˆ shared lib çš„è¯ï¼Œä¹Ÿçœäº† cv ä¸¤æ¬¡çš„æƒ…å†µ

å½“ç„¶ï¼Œåˆ°äº† 2.0 åæƒ…å†µå˜å¾—æ›´å¤æ‚äº†ä¸€äº›ï¼Œshopfront çš„å‡ºç°ï¼Œè®© UI æ–¹é¢é‡å¤çš„ä»£ç å˜å¾—æ›´å¤šäº†ï¼Œåœ¨è¿™äº›é‡å¤çš„ä»£ç ä¹‹ä¸­ï¼Œç®€å•å¯ä»¥åˆ†æˆè¿™ä¸¤ä¸ªéƒ¨åˆ†ï¼š

- å’Œ React æ— å…³çš„ï¼Œçº¯å‡½æ•°çš„é‡å¤
- ä¸ React æœ‰å…³çš„ï¼ŒåŒ…å«äº† UI é‡å¤çš„ç»„ä»¶

ä¹‹å‰æƒ³ç€æ˜¯å¦è¦ä½¿ç”¨å¾®å‰ç«¯å»è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåé¢å‘ç°ï¼Œå¾®å‰ç«¯ä¸»è¦é’ˆå¯¹çš„é—®é¢˜åœ¨ä¸åŒ UI åº“ä¹‹é—´çš„æ‹¼æ¥ï¼Œè¦è§£å†³é‡å¤ä»£ç çš„é—®é¢˜ï¼Œä¸æ˜¯ä¸è¡Œï¼Œå®åœ¨å¤§æå°ç”¨ï¼Œæ€é¸¡ç”¨ç‰›åˆ€ã€‚å¥—åœ¨ç›¸å¯¹æ›´ä½³æˆç†Ÿçš„åç«¯åº”ç”¨åœºæ™¯å°±æ˜¯ï¼Œä¸ºäº†ä¸€ä¸ªé‡å¤çš„ **lib**ï¼Œç‰¹åœ°åšäº†ä¸€å¥—å¾®æœåŠ¡è§£å†³æ–¹æ¡ˆâ€¦â€¦

æ˜¯çš„ï¼Œé—®é¢˜çš„é‡ç‚¹åœ¨è¿™é‡Œï¼šlibï¼ŒAKA dependency

å·²çŸ¥æƒ³è¦æŠ½å‡ºæ¥çš„åŠŸèƒ½ï¼Œè¦ä¹ˆæ˜¯çº¯å‡½æ•°ï¼Œè¦ä¹ˆæ˜¯ UI ç»„ä»¶ï¼Œé‚£ä¹ˆå®Œå…¨å¯ä»¥é€šè¿‡å®ç°ä¸€ä¸ªå†…éƒ¨çš„ä¾èµ–ï¼Œè®©å…¶ä»–çš„é¡¹ç›®åœ¨ package.json ä¸­é€šè¿‡ dependencies å¯¼å…¥çš„æ–¹å¼å»ä½¿ç”¨

## ğŸ“¦Â turborepo & é¡¹ç›®ç»“æ„

è¿™é‡Œéœ€è¦ç®€å•çš„æä¸€ä¸‹ yarn workspace å’Œ turborepo çš„å…³ç³»ã€‚yarn workspace è´Ÿè´£ç®¡ç†ä¾èµ–å’Œ packages çš„å…³è”é—®é¢˜ï¼›turborepo æä¾›äº† compile/transpile çš„æµç¨‹ï¼Œå¹¶ä¸” turborepo äº‹åŸºäº yarn workspace ä¹‹ä¸Šçš„ï¼Œæä¾›äº†é«˜æ•ˆç¼–è¯‘å’Œç¼“å­˜åŠŸèƒ½çš„æ„é€ å·¥å…·

æ¢å¥è¯è¯´ï¼Œä½¿ç”¨ turborepo å¯ä»¥æä¾›æ›´ç»†é¢—ç²’çš„æ§åˆ¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéå¸¸æ»¡è¶³æˆ‘çš„éœ€æ±‚ï¼š

- utils æ–¹æ³•ä¸ä¾èµ–äºä¸»ç¨‹åºã€ç‹¬ç«‹ç¼–è¯‘â€”â€”turborepo æä¾›è¯¥åŠŸèƒ½
- utils æ–¹æ³•å¯ä»¥ä½œä¸ºä¾èµ–ï¼Œè¢«ä¸»ç¨‹åºå¯¼å…¥â€”â€”yarn workspace æä¾›è¯¥åŠŸèƒ½

ç»“æœå°±æ˜¯ï¼Œutils æœ¬èº«å¯ä»¥å®ç°æœ€å¤§å¤ç”¨ï¼Œå¹¶ä¸”å®ƒçš„ç»´æŠ¤/æ›´æ–°æ˜¯ç‹¬ç«‹äºä¸»ç¨‹åºä¹‹å¤–çš„ï¼Œä¹Ÿå°±åšåˆ°äº† DRYã€‚KISS éƒ¨åˆ†ï¼Œåªèƒ½è¯´åˆæœŸæ²¡è¿™ä¹ˆç®€å•ï¼Œä½†æ˜¯åœ¨é…ç½®å®Œäº†åï¼Œä½¿ç”¨å’Œç»´æŠ¤ä¼šå˜å¾—ç®€å•å¾ˆå¤šâ€”â€”utils å¯ä»¥åšç¨³å®šçš„éƒ¨ç½²ï¼Œæ›´æ–°ä¸æµ‹è¯•ä¸ä¸»ç¨‹åºæ— å…³ã€‚åªè¦ä¸ä»‹å…¥ breaking changesï¼Œä¿æŒå‚æ•°ä¸è¿”å›å€¼ä¸€è‡´ï¼Œä¸»ç¨‹åºå…¶å®æ ¹æœ¬ä¸åœ¨ä¹ utils å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„

<aside>
ğŸ’¡

è¡¥å……è¯´æ˜ä¸€ä¸‹ï¼ŒæŠŠ util æ–¹æ³•æ‹‰å‡ºå»åï¼Œå…¶å®ç¼–è¯‘çš„é€Ÿåº¦ä¼šå¿«å¾ˆå¤šã€‚æˆ‘å¹¶ä¸å¤ªç¡®å®š turborepo çš„å¼‚æ­¥ç¼–è¯‘åœ¨è¿™ä¸ªåœ°æ–¹æœ‰å¤šå¤§çš„æ•ˆæœâ€”â€”æ¯•ç«Ÿå­˜åœ¨ä¾èµ–å…³ç³»ï¼Œä½†æ˜¯ turborepo æœ¬èº«æ˜¯æ”¯æŒ HMR+cache çš„ï¼Œå› æ­¤åƒ util è¿™ç§å°æ–¹æ³•ï¼Œç”¨ tsc å‡ ä¹æ˜¯ç§’ç¼–è¯‘

React é‚£è¾¹å¯èƒ½ä¼šè”åŠ¨æ›´æ–°ï¼Œä¸è¿‡åœ¨åªéœ€è¦ä¿®æ”¹å’Œæµ‹è¯• util çš„æƒ…å†µä¸‹ï¼Œå®Œå…¨å¯ä»¥åªè¿è¡Œå¯¹åº”çš„ utilsï¼Œè€Œä¸ç”¨ä¾èµ–æ•´ä¸ª React é¡¹ç›®

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘æåˆ°æå‡ºæ¥çš„æ–¹æ³•æ˜¯çº¯å‡½æ•°ï¼Œæ²¡æœ‰å¤–ç•Œçš„ä¾èµ–

éçº¯å‡½æ•°ç®¡ç†èµ·æ¥ä¼šéå¸¸çš„éº»çƒ¦â€¦â€¦

</aside>

### ğŸ—ï¸Â  é¡¹ç›®ç»“æ„è®¾è®¡

ç›®å‰çš„ç»“æ„å¦‚ä¸‹ï¼š

```bash
â”œâ”€â”€ backend
â”œâ”€â”€ dashboard
â”œâ”€â”€ frontend
â””â”€â”€ packages
    â”œâ”€â”€ apis              # api ç›¸å…³çš„é…ç½®ï¼Œç»™reduxç”¨çš„ï¼Œçº¯config ä¸åŒ…å«çŠ¶æ€
    â”‚Â Â  â”œâ”€â”€ src
    â”‚   â””â”€â”€ tsconfig.json
    â”œâ”€â”€ hooks             # å¦‚ä¸€äº› pagination, debounce search çš„ hooks
    â”‚Â Â  â”œâ”€â”€ src
    â”‚   â””â”€â”€ tsconfig.json
    â”œâ”€â”€ ui                # å¦‚ä¸€äº› paginationï¼Œloaders çš„ ui ç»„ä»¶åº“
    â”‚Â Â  â”œâ”€â”€ src
    â”‚   â””â”€â”€ tsconfig.json
    â””â”€â”€ utils             # ä¸€äº›çº¯å‡½æ•° utilsï¼Œå¦‚ jwt çš„ decode ä¹‹ç±»çš„
     Â Â  â”œâ”€â”€ src
        â””â”€â”€ tsconfig.json
```

å¦å¤–ä¸€ç§è®¾è®¡æ˜¯ä¸»ç¨‹åºä»¬å½’ç±»åœ¨ `app` ä¸‹ï¼Œå’Œ `packages` æˆå¯¹ç«‹çš„ç»“æ„ï¼Œä¸è¿‡è¦å·²ç»å­˜åœ¨çš„é¡¹ç›®ç»“æ„è¦æ”¹å¾ˆå¤šçš„ importï¼Œè€Œä¸”ç›®å‰æ¥è¯´é¡¹ç›®ç»“æ„æ¯”è¾ƒç®€å•â€”â€”æœ€å¤šå†åŠ ä¸€ä¸ª LLM ç›¸å…³çš„æ¨¡å—ï¼Œå› æ­¤ä¿ç•™ç°åœ¨çš„å®ç°é—®é¢˜ä¹Ÿä¸å¤§

<aside>
ğŸ””

æ ¹ç›®å½•ä¸‹è¿˜æœ‰ä¸€ä¸ªæ–°å¢çš„ tsconfig.base.jsonï¼Œç°åœ¨æƒ³æ³•æ˜¯è¿™ä¸ª config æ–‡ä»¶å¯ä»¥ä½œä¸ºæ‰€æœ‰é¡¹ç›®çš„ base templateï¼Œä¹‹åçš„é¡¹ç›®åªè¦ç»§æ‰¿è¿™ä¸ª configï¼Œå¹¶ä¸”æ ¹æ®éœ€æ±‚é‡å†™å³å¯ã€‚é¡¹ç›®ç»“æ„æ˜¯ç”¨ `tree` è·‘çš„ï¼Œæ‰‹åŠ¨åŠ å¤ªéº»çƒ¦äº†ï¼Œè¿™é‡Œå°±å·ä¸ªæ‡’

</aside>

## ğŸ› ï¸ TypeScript çš„è½å®

è¿™é‡Œä»£ç æœ€ç»ˆè¿˜æ˜¯é€‰æ‹©ä½¿ç”¨ TypeScript å»è½å®ï¼Œä¸»è¦çš„åŸå› æ˜¯å› ä¸ºæç¤ºæ¯”è¾ƒæ–¹ä¾¿â€”â€”ä¸»è¦è¿˜æ˜¯å› ä¸º utils çš„æ–¹æ³•æ˜¯å…±ç”¨çš„ï¼Œææ—©è§„èŒƒæ¯”ä¸è§„èŒƒå¥½

### base ts config

è¿™ä¸ªå°±æ˜¯åœ¨æ ¹ç›®å½•ä¸‹çš„ ts configï¼š

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "Node",
    "declaration": true,
    "outDir": "dist",
    "strict": true,
    "jsx": "react-jsx",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "baseUrl": ".",
    "paths": {
      "@mern/utils": ["packages/utils/src"],
      "@mern/hooks": ["packages/hooks/src"],
      "@mern/ui": ["packages/ui/src"],
      "@mern/apis": ["packages/apis/src"]
    }
  },
  "references": [
    { "path": "./packages/utils" },
    { "path": "./packages/hooks" },
    { "path": "./packages/ui" },
    { "path": "./packages/apis" }
  ]
}
```

è¿™é‡Œæ¯”è¾ƒé‡è¦çš„æ˜¯ä¸¤ä¸ªé…ç½®ï¼š

- paths - è®©å…¶ä»– TS æ–‡ä»¶/é¡¹ç›®åœ¨ç¼–è¯‘çš„æ—¶å€™çŸ¥é“ï¼Œåˆ°ä»€ä¹ˆè·¯å¾„å»æ‰¾å¯¹åº”çš„æ–‡ä»¶
- references - è®©å…¶ä»– TS æ–‡ä»¶/é¡¹ç›®åœ¨ç¼–è¯‘çš„æ—¶å€™çŸ¥é“ï¼Œå¯¹åº”çš„æ¨¡å—ï¼ˆå­é¡¹ç›®ï¼‰
  è¿™ä¸ªé…ç½®è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œå› ä¸º turborepo ä¼šæ ¹æ®è¿™ä¸ªé…ç½®å»è‡ªåŠ¨æ¨å¯¼ build çš„å…ˆåé¡ºåºï¼Œå°¤å…¶æ˜¯åœ¨å½“å‰é¡¹ç›®é‡Œï¼Œå…¶ä»–çš„è¾…åŠ©æ–¹æ³•å¯èƒ½å¯¹ `utils` ä¸­çš„æ–¹æ³•æœ‰ä¾èµ–

### child ts config

è¿™é‡Œæˆ‘æŒ‘çš„æ˜¯ ui ä¸­çš„ tsconfigï¼Œä¸»è¦æ˜¯å› ä¸º ui å¯¹ utils æ˜¯æœ‰ä¾èµ–å…³ç³»çš„ã€‚è‡³å°‘åœ¨è¿™ä¸ªé¡¹ç›®é‡Œï¼Œè¿™ä¸ªå­—é¡¹ç›®çš„ tsconfig æ˜¯æœ€å¤æ‚çš„é…ç½® ~~ä¹‹ä¸€~~

```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "rootDir": "src",
    "outDir": "dist",
    "composite": true,
    "declaration": true
  },
  "include": ["src"],
  "exclude": ["node_modules", "dist"],
  "references": [{ "path": "../utils" }]
}
```

è¿™é‡Œå°±æä¸€ä¸‹æ¯”è¾ƒå°‘ç”¨åˆ°çš„å‡ ä¸ªé…ç½®å§ï¼Œå…¶ä»–çš„éƒ½è¿˜æŒºç›´æ¥çš„ï¼š

- compositeï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå³å¯ä»¥è¢«åˆ«çš„åŒ…ä¾èµ–çš„å­é¡¹ç›®
  è¿™ä¸ªé…ç½®æœ‰ä¸€ä¸ªæ›´ç‰¹æ®Šçš„ç‚¹ï¼Œå°±æ˜¯å‘Šè¯‰ tsc/turborepo å¯ä»¥å®ç° incremental buildï¼Œå³åªç¼–è¯‘ä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼Œè·³è¿‡å…¶ä»–ä½ä¿®æ”¹çš„æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥æå¤§åœ°æé«˜ç¼–è¯‘é€Ÿåº¦
    <aside>
    â—
    
    è¿™é‡Œä¹Ÿæ˜¯æœ‰ä¸€ä¸ªå‘çš„ï¼Œå¦‚æœåˆ é™¤æ‰å¯¹åº”çš„æ–‡ä»¶ï¼Œåœ¨compositeä¸ºtrueçš„æƒ…å†µä¸‹ï¼Œdistä¸­çš„æ–‡ä»¶ä¸ä¼šè¢«åˆ é™¤ï¼Œæ‰€ä»¥æˆ‘åœ¨åšrefactorçš„æ—¶å€™é‡åˆ°è¿‡å¥½å‡ æ¬¡ç±»ä¼¼çš„é—®é¢˜
    
    ç›®å‰é‡‡å–çš„æ˜¯æ‰‹åŠ¨çš„åˆ é™¤æ–¹æ³•â€”â€”æ¯•ç«Ÿä»£ç é‡æ¯”è¾ƒå°ã€‚ä½†æ˜¯ä¹‹åå¯èƒ½ä¼šè€ƒè™‘ä¿®æ”¹ä¸€ä¸‹tasksï¼Œå…ˆåšcleanå†build
    
    </aside>

- declarationï¼Œç”Ÿæˆå¯¹åº”çš„ `d.ts` ç±»å‹å£°æ˜æ–‡ä»¶
  æˆ‘æ˜¯çœ‹åˆ°é…ç½®æ¨èå¼€å°±å¼€äº†ï¼Œä¸è¿‡åœ¨çœ‹å…¶ä»–çš„æ–‡æ¡£æ—¶æœ‰ç„åˆ°ï¼Œå¦‚æœä¸å¼€çš„è¯ï¼Œæœ‰å¯èƒ½å…¶ä»–çš„åŒ…ä¼šæ‰¾ä¸åˆ°å¯¹åº” declarationï¼Œç„¶åä¸èƒ½ infer ç±»å‹/æ–¹æ³•/å‚æ•°â€¦â€¦ï¼Ÿ
  ä¸è¿‡æˆ‘ç›®å‰ç”¨çš„æ˜¯ JS æ–‡ä»¶ï¼Œè€Œä¸”ä¹Ÿå¼€äº†è¿™ä¸ªé…ç½®ï¼Œæ‰€ä»¥æ²¡é‡åˆ°è¿‡è¿™ä¸ªé—®é¢˜
- referencesï¼Œå£°æ˜ä¾èµ–å…³ç³»ï¼Œè¿™æ · tsc/turborepo å¯ä»¥æ¨å¯¼ build çš„å…ˆåé¡ºåº

## ğŸ”§Â package.json çš„é…ç½®

åŒæ ·åˆ†ä¸º root level çš„ package.json å’Œå­é¡¹ç›®çš„ package.json

### root package.json

é…ç½®å¦‚ä¸‹ï¼š

```json
{
  "devDependencies": {
    "typescript": "^5.8.3"
  },
  "workspaces": ["backend", "dashboard", "frontend", "packages/*"],
  "scripts": {
    "start": "turbo run start",
    "start:dev": "turbo run start:debug --parallel",
    "start:utils": "turbo run start:debug --filter=@mern/utils --concurrency=2",
    "start:ui": "turbo run start:debug --filter=@mern/ui --concurrency=2",
    "start:hooks": "turbo run start:debug --filter=@mern/hooks --concurrency=2",
    "start:packages": "turbo run start:debug --filter=@mern/utils --filter=@mern/ui --filter=@mern/hooks --concurrency=3"
  }
}
```

è¿™é‡Œä¸»è¦ä¿®æ”¹çš„å°±æ˜¯ è¿™ä¸‰ä¸ªåœ°æ–¹ï¼Œ å…¶å®éƒ½æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸€ä¸ªæ˜¯å¼€å‘æ—¶çš„ä¾èµ–ï¼Œä¸€ä¸ªæ˜¯ `workspaces` â†’ è¿™é‡Œç”¨çš„æ˜¯ `packages/*` ï¼Œæ‰€ä»¥ä¼šåŒ…å« packages ä¸‹é¢çš„æ‰€æœ‰é¡¹ç›®ï¼Œæ ¹ç›®å½•åªéœ€è¦é…ç½®ä¸€æ¬¡å³å¯

è„šæœ¬é‡Œé¢éœ€è¦æ³¨æ„çš„å°±æ˜¯è¿™ä¸¤ä¸ªå‚æ•°äº†ï¼š

- `--parallel` ï¼Œè¿™ä¸ªè¡¨ç¤ºæ‰€æœ‰çš„é¡¹ç›®éƒ½ä¼šå¹¶å‘è¿è¡Œï¼Œå®Œå…¨çš„éé˜»å¡â€”â€”å½“ç„¶è¿˜æ˜¯å–å†³äºç”µè„‘çš„é…ç½®
- `--concurrency` ï¼ŒåŒæ—¶å¹¶è¡Œè¿è¡Œ n ä¸ªæŒ‡ä»¤ï¼Œé˜»å¡å¼è¿è¡Œ
  æˆ‘åŠ è¿™ä¸ª flag ä¸»è¦æ˜¯ä¹‹å‰è·‘çš„æ—¶å€™å‡ºç°äº†ä¸€ä¸ª recursive calï¼š
  ![](https://i-blog.csdnimg.cn/direct/4f89f1d41d084bf9a5c3b37c981d0d27.png)

æ‰€ä»¥æˆ‘åŠ äº†è¿™ä¸ª flag åšäº†ä¸€ä¸‹æµ‹è¯•

<aside>
â—

è¿™é‡Œè¿˜æ˜¯è¦å¤šå˜´é¢˜ä¸€ä¸‹è¿™ä¸ªé˜»å¡å¼è¿è¡Œï¼Œæˆ‘ä¹‹å‰åœ¨ debug çš„æ—¶å€™ä¹Ÿç¢°åˆ°è¿‡ä¸å°‘çš„é—®é¢˜

é¦–å…ˆï¼Œè¿™ä¸ªé˜»å¡å¼è¿è¡Œä¸»è¦æ˜¯é’ˆå¯¹çš„é hanging å‘½ä»¤ï¼Œå¦‚ build æŒ‡ä»¤ã€‚ä½†æ˜¯é‡ä¸Š hanging æŒ‡ä»¤â€”â€”æ¯”å¦‚è¯´å¸¦ `--watch` çš„æŒ‡ä»¤ï¼Œå¿…é¡»è¦ä¿è¯å½“å‰å¯ä»¥å¹¶è¡Œè¿è¡Œçš„ä»»åŠ¡ â‰¥ æŒ‚æœºæŒ‡ä»¤

æ¯”å¦‚è¯´æˆ‘ä¹‹å‰é‡åˆ°è¿™ä¸ª recursive è°ƒç”¨ï¼Œä¸€ç›´å¢åŠ æŒ‚æœºæŒ‡ä»¤ï¼Œå¦‚æœæˆ‘è®¾ç½®äº† `--concurrency=2` ï¼Œé‚£ä¹ˆç¬¬ä¸‰ä¸ªæŒ‚æœºæŒ‡ä»¤å‡ºç°åï¼Œturborepo å°±ä¼šè‡ªåŠ¨æŠ¥é”™ï¼Œå¹¶ä¸”åœæ­¢è¿è¡Œï¼Œå› ä¸ºå½“å‰å¯ä»¥è¿è¡Œçš„æŒ‡ä»¤è¶…è¿‡äº†ä¸Šé™ï¼ŒæŠ¥é”™å¼‚å¸¸å¦‚ä¸‹ï¼š

```bash
@mern/utils:start:debug: turbo 2.4.4
@mern/utils:start:debug:
@mern/utils:start:debug:   Ã— Invalid task configuration
@mern/utils:start:debug:   â•°â”€â–¶   Ã— You have 1 persistent tasks but `turbo` is configured for concurrency of 1. Set --concurrency to at least 2
@mern/utils:start:debug:
error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
```

</aside>

å…·ä½“çš„é«˜çº§é…ç½®ï¼Œå¦‚å¹¶è¡Œ/ä¸²è¡Œ/å…ˆåè°ƒåº¦ç­‰ï¼Œæš‚æ—¶ä¸ä¼šè¿‡å¤šæ·±å…¥ï¼Œå¦‚æœç¢°åˆ°å…·ä½“çš„é—®é¢˜å†ç»§ç»­ç ”ç©¶ã€‚

### child package.json

ä¾æ—§åªæŒ‘æœ€å¤æ‚çš„ ui ä½œä¸ºæ¡ˆä¾‹ï¼š

```json
{
  "name": "@mern/ui",
  "version": "0.1.0",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "scripts": {
    "build": "tsc",
    "start": "tsc --watch",
    "start:debug": "tsc --watch"
  },
  "devDependencies": {
    "@types/react": "^19.1.2",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-icons": "^5.5.0",
    "tailwindcss": "3"
  },
  "peerDependencies": {
    "react": "^18.0.0 || ^19.0.0",
    "react-dom": "^18.0.0 || ^19.0.0",
    "react-icons": "^5.0.0"
  },
  "dependencies": {
    "@mern/hooks": "*",
    "@mern/utils": "*",
    "react-spinners": "^0.17.0"
  }
}
```

è¿™é‡Œä¹Ÿæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œæˆ‘åªæ˜¯å‡ºäºè§„èŒƒå¤šè°¢äº†ç‚¹ä¾èµ–ï¼ŒæŠŠ devDependenciesã€peerDependencies å’Œ dependencies éƒ½è¡¥å…¨äº†

<aside>
â„¹ï¸

å¦‚æœä¸å¤ªç†è§£ peerDependencies çš„è¯ï¼Œå®ƒè¿™ä¸ªæ„æ€å°±æ˜¯è¯´ï¼Œå½“å‰ packages ä¸ä¼šä¸‹è½½å¯¹åº”çš„ dependenciesï¼Œå¼•ç”¨è¿™ä¸ªåŒ…é¡¹ç›®éœ€è¦è‡ªå·±ä¸‹è½½

</aside>

## ğŸš€Â  è¿è¡Œ

1. å¼€å‘æ—¶æ‰‹åŠ¨ build

   ```bash
   â¯ yarn workspace @mern/utils build
   â¯ yarn workspace @mern/hooks build
   â¯ yarn workspace @mern/ui build

   # or
   â¯ turbo run build
   ```

2. å¼€å‘æ—¶ä½¿ç”¨ watch è‡ªåŠ¨ build

   ```json
   "scripts": {
     "start": "tsc --watch"
   }
   ```

3. ä½¿ç”¨ turbo è¿›è¡Œç®¡ç†

   ```json
   "scripts": {
   	"start": "turbo run start --concurrency=1 --filter=@mern/ui",
   	"start:debug": "turbo run start:debug --concurrency=1 --filter=@mern/ui"
   }
   ```

   æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ç”¨ `yarn start:dev`ï¼Œå°±æ˜¯åœ¨ä¸» package.json é‡Œé¢é…ç½®å¥½çš„æŒ‡ä»¤ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

   ![](https://i-blog.csdnimg.cn/direct/8ce3f68e77164e7a9abc9843fd78618b.gif#pic_center)

## ğŸª²Â  æ’é”™ç¯‡

### â€œnot under rootDirâ€ æŠ¥é”™

è¿™ä¹Ÿæ˜¯æˆ‘åœ¨ç¬”è®° 2.0 ä¸­æåˆ°è¿‡çš„é—®é¢˜ï¼Œè¿™æ¬¡é€‰æ‹©åœ¨æ ¹ç›®å½•ä¸‹å®‰è£…äº† TS çš„ç‰ˆæœ¬ï¼Œä¸ºäº†ä¹‹åå¯ä»¥æ…¢æ…¢ rollout TS çš„å‡çº§ï¼š

```bash
â¯ yarn add -D typescript -W

yarn add v1.22.22
[1/4] ğŸ”  Resolving packages...
[2/4] ğŸšš  Fetching packages...
[3/4] ğŸ”—  Linking dependencies...
warning "workspace-aggregator-fc368999-27cb-4e16-84a5-213b8e977a99 > dashboard > react-scripts > eslint-config-react-app > eslint-plugin-flowtype@8.0.3" has unmet peer dependency "@babel/plugin-syntax-flow@^7.14.5".
warning "workspace-aggregator-fc368999-27cb-4e16-84a5-213b8e977a99 > dashboard > react-scripts > eslint-config-react-app > eslint-plugin-flowtype@8.0.3" has unmet peer dependency "@babel/plugin-transform-react-jsx@^7.14.9".
warning Workspaces can only be enabled in private projects.
[4/4] ğŸ”¨  Building fresh packages...
success Saved lockfile.
warning Workspaces can only be enabled in private projects.
success Saved 1 new dependency.
info Direct dependencies
â””â”€ typescript@5.8.3
info All dependencies
â””â”€ typescript@5.8.3
âœ¨  Done in 7.28s.
```

### æ‰¾ä¸åˆ°å¯¼å…¥

æ­£å¸¸çš„å¯¼å…¥åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

![](https://i-blog.csdnimg.cn/direct/d06370cfe7614f8e9e5ef1c23043e446.png)

å¦‚æœé‡åˆ°å¯¼å…¥å¤±è´¥ï¼Œå¯ä»¥å…ˆé€šè¿‡åœ¨æ ¹ç›®å½•ä¸‹è¿è¡Œ `ls node_modules/@mern/utils` æˆ– `tree node_modules/@mern/utils` ï¼Œä¸»è¦æ˜¯ä¸ºäº†ç¡®å®šä¸€ä»¶äº‹æƒ…â€”â€”å¯¹åº”çš„ packages ç¡®å®è¢«æˆåŠŸæ‰“åŒ…äº†

æˆ‘é‡åˆ°è¿‡ä¸¤ç§æƒ…å†µï¼š

1. ç©ºæ–‡ä»¶å¤¹

   è¿™ç§æƒ…å†µå¯èƒ½æ˜¯å› ä¸ºåå­—ä¸å¯¹ï¼ŒæŸ¥çœ‹å­é¡¹ç›®ä¸­çš„ package.json ä¸­çš„ `name` å’Œæ ¹ç›®å½•ä¸‹çš„ tsconfig ä¸­çš„ `paths` & `references` æ˜¯å¦ä¸€è‡´

2. æ–‡ä»¶å¤¹ä¸‹æ˜¯å¥‡æ€ªçš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯å¯¹åº”çš„ js/d.ts æ–‡ä»¶

   è¿™æ˜¯å› ä¸ºæˆ‘é‡å‘½åäº†ï¼Œä¸çŸ¥é“ä»€ä¹ˆ symlink æ²¡æˆåŠŸ

å®Œæˆæ’æŸ¥åï¼Œåœ¨æ ¹ç›®å½•ä¸‹è¿è¡Œ `yarn install --force` å®Œæˆä¸€æ¬¡é‡æ–°å®‰è£…ï¼Œyarn workspace ä¼šå¼ºåˆ¶é‡æ–°æ›´æ–°æ‰€æœ‰çš„ symlink

æœ€å·®æƒ…å†µä¸‹éœ€è¦æŠŠ node_modules åˆ é™¤ï¼Œç„¶ååšæ•´ä½“çš„é‡æ–°å®‰è£…

### tailwindcss ä¸èµ·æ•ˆ

æŸ¥çœ‹ tailwind çš„ config æ–‡ä»¶ï¼Œè¿™ç§æƒ…å†µå¤§å¤šæ•°æ˜¯å› ä¸º `content` é‡Œé¢æ²¡æœ‰åŒ…å«ç¬¬ä¸‰æ–¹åº“â€”â€”å­é¡¹ç›®ä¸­ä¸åŒ…å« tailwindï¼Œæ‰€ä»¥ä¸ä¼šåœ¨å­é¡¹ç›®ä¸­ä¿®æ”¹æ ·å¼

æˆ‘ç›®å‰çš„é…ç½®æ˜¯è¿™æ ·çš„ï¼š

```jsx
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./src/**/*.{js,jsx,ts,tsx}",
    "../packages/ui/**/*.{js,ts,jsx,tsx}",
    "./node_modules/@mern/ui/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
};
```

ç¬¬äºŒæ¡æ˜¯ç»™æœ¬åœ°å¼€å‘ï¼Œç¬¬ä¸‰æ¡æ˜¯ç»™æœªæ¥ production ç”¨â€¦â€¦ä¸è¿‡ç¬¬ä¸‰æ¡åº”è¯¥æ˜¯ç”¨ä¸ä¸Šçš„â€¦â€¦
